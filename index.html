<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Başlıklar</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
<div id="container">
  <h1>Başlıklar</h1>

  <div class="input-group">
    <input type="text" id="titleInput" placeholder="Yeni başlık (ör: a)" />
    <button id="addBtn">Ekle</button>
  </div>

  <ul id="itemsList"></ul>
</div>

<script type="module">
import { checkAuth, userRootRef } from './firebaseConfig.js';
import { onValue, set, remove, child, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const titleInput = document.getElementById('titleInput');
const addBtn = document.getElementById('addBtn');
const itemsList = document.getElementById('itemsList');

let currentUserId = null;

// Firebase key olarak kullanılamayan karakterleri temizle
function sanitizeKey(s) {
  return String(s || '').trim()
    .replace(/\//g, '-')       
    .replace(/[.$#[\]]/g, '-') 
    .replace(/\s+/g, ' ')      
    .replace(/^\s+|\s+$/g, ''); 
}

checkAuth(user => {
  currentUserId = user.uid;
  const rootRef = userRootRef(currentUserId);

  onValue(rootRef, snapshot => {
    itemsList.innerHTML = '';
    if (!snapshot.exists()) return;
    snapshot.forEach(childSnap => {
      const key = childSnap.key;
      const li = document.createElement('li');
      li.style.display = "flex";
      li.style.alignItems = "center";
      li.style.gap = "8px";

      const nameSpan = document.createElement('span');
      nameSpan.textContent = key;
      nameSpan.style.cursor = "pointer";
       // Başlığa tıklayınca page.html aç
      nameSpan.addEventListener('click', () => {
        const path = encodeURIComponent(key);
        window.location.href = `page.html?path=${path}`;
      });


      const delBtn = document.createElement('button');
      delBtn.textContent = "Sil";
      delBtn.className = "deleteBtn";
      delBtn.addEventListener('click', e => {
        e.stopPropagation();
        if (!confirm(`"${key}" silinsin mi?`)) return;
        remove(child(rootRef, key)).catch(err => alert('Silme hatası: ' + err.message));
      });

      li.appendChild(nameSpan);
      li.appendChild(delBtn);
      itemsList.appendChild(li);
    });
  });

  addBtn.addEventListener('click', async () => {
    const raw = titleInput.value;
    const key = sanitizeKey(raw);
    if (!key) return alert('Lütfen geçerli bir başlık girin!');
    const existing = await get(child(rootRef, key));
    if (existing.exists()) return alert('Bu başlık zaten var!');
    set(child(rootRef, key), { type: "title" })
      .then(() => { titleInput.value = ''; })
      .catch(err => alert('Ekleme hatası: ' + err.message));
  });

}, 'login.html');
</script>
</body>
</html>
