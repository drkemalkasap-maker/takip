<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Items</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="container">
  <div class="input-group">
    <input type="text" id="titleInput" placeholder="Enter item" />
    <button id="addBtn">Add</button>
  </div>
  <ul id="itemsList"></ul>
</div>

<script type="module">
import { checkAuth, userItemsRef } from './firebaseConfig.js';
import { onValue, set, remove, child } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const addBtn = document.getElementById("addBtn");
const titleInput = document.getElementById("titleInput");
const itemsList = document.getElementById("itemsList");

let currentUserId = null;

// Kullanıcıyı kontrol et ve veri yükle
checkAuth(user => {
  currentUserId = user.uid;
  const itemsRef = userItemsRef(currentUserId);

  // Verileri dinle ve listele
  onValue(itemsRef, snapshot => {
    itemsList.innerHTML = "";
    snapshot.forEach(childSnap => {
      const li = document.createElement("li");

      const span = document.createElement("span");
      span.textContent = childSnap.key; // Başlık
      span.className = "itemText";

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "deleteBtn";
      deleteBtn.addEventListener("click", e => {
        e.stopPropagation();
        remove(child(itemsRef, childSnap.key));
      });

      li.appendChild(span);
      li.appendChild(deleteBtn);

      li.addEventListener("click", () => {
        window.location.href = `edit.html?id=${encodeURIComponent(childSnap.key)}`;
      });

      itemsList.appendChild(li);
    });
  });

}, 'login.html'); // kullanıcı yoksa login sayfasına yönlendir

// Yeni item ekleme
addBtn.addEventListener("click", () => {
  const title = titleInput.value.trim();
  if (!title) return alert("Please enter a title!");
  if (!currentUserId) return alert("User not loaded yet!");

  // Firebase'de geçerli key'e dönüştür (özel karakterleri temizle)
  const sanitizedKey = title.replace(/[.#$/\[\]]/g, "_");

  const itemsRef = userItemsRef(currentUserId);
  const itemRef = child(itemsRef, sanitizedKey);

  set(itemRef, { type: "title" });
  titleInput.value = "";
});
</script>

</body>
</html>
