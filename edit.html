<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Item</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div id="container">
  <h1 id="itemTitle">Loading...</h1>

  <div class="input-group">
    <input type="text" id="subtitleInput" placeholder="Enter subitem" />
    <button id="addSubBtn">Add Subitem</button>
  </div>

  <ul id="subitemsList"></ul>
</div>

<script type="module">
import { checkAuth, db } from './firebaseConfig.js';
import { ref, child, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// DOM
const itemTitle = document.getElementById("itemTitle");
const subtitleInput = document.getElementById("subtitleInput");
const addSubBtn = document.getElementById("addSubBtn");
const subitemsList = document.getElementById("subitemsList");

// Get path from URL
const urlParams = new URLSearchParams(window.location.search);
const idParam = urlParams.get("id"); // a_aa_aaa gibi
if (!idParam) {
  alert("Item not found");
  window.location.href = "index.html";
}
const pathSegments = idParam.split("_"); // ['a', 'aa', 'aaa']

// Show path as title
itemTitle.textContent = pathSegments.join(" / ");

// Kullanıcı kontrolü
checkAuth(user => {
  let currentRef = ref(db, `users/${user.uid}`);
  pathSegments.forEach(seg => currentRef = child(currentRef, seg));

  onValue(currentRef, snapshot => {
    console.log("Dinlenen yol:", `users/${user.uid}/${pathSegments.join("/")}`);
    console.log("Snapshot:", snapshot.val());
    subitemsList.innerHTML = "";
    const data = snapshot.val();
    if (!data) return;

Object.keys(data).forEach(key => {
  if (key === "type") return;

  const li = document.createElement("li");
  li.style.cursor = "pointer"; // Tüm li tıklanabilir gibi görünmeli

  // 👇 Bu event artık li üzerinde
  li.addEventListener("click", () => {
    const newId = [...pathSegments, key].join("_");
    console.log("Navigating to:", newId);
    window.location.href = `edit.html?id=${encodeURIComponent(newId)}`;
  });

  const span = document.createElement("span");
  span.textContent = key;

  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "Delete";

  // ❗ Dikkat: Burada stopPropagation kullanıyoruz
  deleteBtn.addEventListener("click", e => {
    e.stopPropagation(); // li'ye tıklamayı engelle
    remove(child(currentRef, key));
  });

  li.append(span, deleteBtn);
  subitemsList.append(li);
});

  });

  // Alt başlık ekleme
  addSubBtn.addEventListener("click", async () => {
  const subTitle = subtitleInput.value.trim();
  if (!subTitle) return alert("Please enter a subitem!");

  if (subTitle.includes(":")) {
    const [rawKey, ...rest] = subTitle.split(":");
    const rawValue = rest.join(":"); // ":" birden fazla olabilir

    const key = rawKey.trim().replace(/[.#$/\[\]]/g, "_");
    const value = rawValue.trim();

    if (!key || !value) return alert("Invalid format. Use 'Key: Value'.");

    const subRef = child(currentRef, key);
    const exists = await get(subRef);
    if (exists.exists()) {
      return alert("This subitem already exists!");
    }

    await set(subRef, value);
  } else {
    const sanitizedKey = subTitle.replace(/[.#$/\[\]]/g, "_");
    const subRef = child(currentRef, sanitizedKey);

    const exists = await get(subRef);
    if (exists.exists()) {
      return alert("This subitem already exists!");
    }

    await set(subRef, { type: "subtitle" });
  }

  subtitleInput.value = "";
});

}, 'login.html');

</script>

</body>
</html>
