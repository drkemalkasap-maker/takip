<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Item</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div id="container">
  <h1 id="itemTitle">Loading...</h1>

  <div class="input-group">
    <input type="text" id="subtitleInput" placeholder="Enter subitem" />
    <button id="addSubBtn">Add Subitem</button>
  </div>

  <ul id="subitemsList"></ul>
</div>

<script type="module">
import { checkAuth, userItemRef } from './firebaseConfig.js';
import { onValue, set, remove, child } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// DOM Elements
const itemTitle = document.getElementById("itemTitle");
const subtitleInput = document.getElementById("subtitleInput");
const addSubBtn = document.getElementById("addSubBtn");
const subitemsList = document.getElementById("subitemsList");

// Get main item title from URL
const urlParams = new URLSearchParams(window.location.search);
const mainKey = urlParams.get("id");
if (!mainKey) {
  alert("Item not found");
  window.location.href = "index.html";
}

// Sayfa başlığı
itemTitle.textContent = mainKey;

// Kullanıcıyı kontrol et
checkAuth(user => {
  const mainRef = userItemRef(user.uid, mainKey);

  // Listeleme
  onValue(mainRef, snapshot => {
    subitemsList.innerHTML = "";
    const data = snapshot.val();

    for (const key in data) {
      if (key === "type") continue; // sadece "title" ana veriyi atla
      const value = data[key];

      const li = document.createElement("li");
      const span = document.createElement("span");
      span.textContent = key;

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "deleteBtn";
      deleteBtn.addEventListener("click", e => {
        e.stopPropagation();
        remove(child(mainRef, key));
      });

      li.appendChild(span);
      li.appendChild(deleteBtn);
      subitemsList.appendChild(li);
    }
  });

  // Alt başlık ekleme
  addSubBtn.addEventListener("click", () => {
    const subTitle = subtitleInput.value.trim();
    if (!subTitle) return alert("Please enter a subitem!");

    const sanitizedKey = subTitle.replace(/[.#$/\[\]]/g, "_");
    const subRef = child(mainRef, sanitizedKey);
    set(subRef, { type: "subtitle" });

    subtitleInput.value = "";
  });

}, 'login.html');
</script>

</body>
</html>
