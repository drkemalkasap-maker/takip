<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Item</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div id="container">
  <h1 id="itemTitle">Loading...</h1>

  <div class="input-group">
    <input type="text" id="subtitleInput" placeholder="Enter subitem" />
    <button id="addSubBtn">Add Subitem</button>
  </div>

  <ul id="subitemsList"></ul>
</div>

<script type="module">
import { checkAuth, userItemRef } from './firebaseConfig.js';
import { onValue, set, remove, child } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// DOM
const itemTitle = document.getElementById("itemTitle");
const subtitleInput = document.getElementById("subtitleInput");
const addSubBtn = document.getElementById("addSubBtn");
const subitemsList = document.getElementById("subitemsList");

// Get current item ID (could be a main or subitem)
const urlParams = new URLSearchParams(window.location.search);
const currentKey = urlParams.get("id");
if (!currentKey) {
  alert("Item not found");
  window.location.href = "index.html";
}

// Show title
itemTitle.textContent = currentKey;

// Auth check
checkAuth(user => {
  const currentRef = userItemRef(user.uid, currentKey);

  // Read children of current item
  onValue(currentRef, snapshot => {
    subitemsList.innerHTML = "";
    const data = snapshot.val();

    if (!data) return;

    for (const key in data) {
      if (key === "type") continue;

      const li = document.createElement("li");
      const span = document.createElement("span");
      span.textContent = key;
      span.style.cursor = "pointer";

      // Alt başlığa tıklanınca edit.html?id=key olarak aç
      span.addEventListener("click", () => {
        window.location.href = `edit.html?id=${encodeURIComponent(key)}`;
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "deleteBtn";
      deleteBtn.addEventListener("click", e => {
        e.stopPropagation();
        remove(child(currentRef, key));
      });

      li.appendChild(span);
      li.appendChild(deleteBtn);
      subitemsList.appendChild(li);
    }
  });

  // Yeni alt başlık ekle
  addSubBtn.addEventListener("click", () => {
    const subTitle = subtitleInput.value.trim();
    if (!subTitle) return alert("Please enter a subitem!");

    const sanitizedKey = subTitle.replace(/[.#$/\[\]]/g, "_");
    const subRef = child(currentRef, sanitizedKey);
    set(subRef, { type: "subtitle" });

    subtitleInput.value = "";
  });

}, 'login.html');
</script>

</body>
</html>
