<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Item</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div id="container">
  <h1 id="itemTitle">Loading...</h1>

  <div class="input-group">
    <input type="text" id="subtitleInput" placeholder="Enter subitem" />
    <button id="addSubBtn">Add Subitem</button>
  </div>

  <ul id="subitemsList"></ul>
</div>

<script type="module">
import { checkAuth, db } from './firebaseConfig.js';
import { ref, child, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// DOM
const itemTitle = document.getElementById("itemTitle");
const subtitleInput = document.getElementById("subtitleInput");
const addSubBtn = document.getElementById("addSubBtn");
const subitemsList = document.getElementById("subitemsList");

// Get path from URL
const urlParams = new URLSearchParams(window.location.search);
const idParam = urlParams.get("id"); // a_aa_aaa gibi
if (!idParam) {
  alert("Item not found");
  window.location.href = "index.html";
}
const pathSegments = idParam.split("_"); // ['a', 'aa', 'aaa']

// Show path as title
itemTitle.textContent = pathSegments.join(" / ");

checkAuth(user => {
  // Firebase yolunu oluştur
  let currentRef = ref(db, `users/${user.uid}`);
  pathSegments.forEach(segment => {
    currentRef = child(currentRef, segment);
  });

  // Listeleme
  onValue(currentRef, snapshot => {
    subitemsList.innerHTML = "";
    const data = snapshot.val();
    if (!data) return;

    for (const key in data) {
      if (key === "type") continue;

      const li = document.createElement("li");

      const span = document.createElement("span");
      span.textContent = key;
      span.style.cursor = "pointer";

      // Alt başlığa tıklanınca yeni URL oluştur
      const newId = [...pathSegments, key].join("_");
      span.addEventListener("click", () => {
        window.location.href = `edit.html?id=${encodeURIComponent(newId)}`;
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "deleteBtn";
      deleteBtn.addEventListener("click", e => {
        e.stopPropagation();
        remove(child(currentRef, key));
      });

      li.appendChild(span);
      li.appendChild(deleteBtn);
      subitemsList.appendChild(li);
    }
  });

  // Alt başlık ekleme
  addSubBtn.addEventListener("click", async () => {
    const subTitle = subtitleInput.value.trim();
    if (!subTitle) return alert("Please enter a subitem!");

    const sanitizedKey = subTitle.replace(/[.#$/\[\]]/g, "_");
    const subRef = child(currentRef, sanitizedKey);

    const exists = await get(subRef);
    if (exists.exists()) {
      return alert("This subitem already exists!");
    }

    await set(subRef, { type: "subtitle" });
    subtitleInput.value = "";
  });

}, 'login.html');
</script>

</body>
</html>
