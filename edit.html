<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Item</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div id="container">
  <h1 id="itemTitle">Loading...</h1>

  <div class="input-group">
    <input type="text" id="subtitleInput" placeholder="Enter subitem" />
    <button id="addSubBtn">Add Subitem</button>
  </div>

  <ul id="subitemsList"></ul>
</div>

<script type="module">
import { checkAuth, userItemRef } from './firebaseConfig.js';
import { onValue, set, remove, child } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// DOM Elements
const itemTitle = document.getElementById("itemTitle");
const subtitleInput = document.getElementById("subtitleInput");
const addSubBtn = document.getElementById("addSubBtn");
const subitemsList = document.getElementById("subitemsList");

// Get main item title from URL
const urlParams = new URLSearchParams(window.location.search);
const mainKey = urlParams.get("id");
if (!mainKey) {
  alert("Item not found");
  window.location.href = "index.html";
}

// Sayfa başlığını ayarla
itemTitle.textContent = mainKey;

// Kullanıcıyı kontrol et
checkAuth(user => {
  const subitemsRef = child(userItemRef(user.uid, mainKey), "subitems");

  // Listeleme
  onValue(subitemsRef, snapshot => {
    subitemsList.innerHTML = "";
    snapshot.forEach(childSnap => {
      const li = document.createElement("li");

      const span = document.createElement("span");
      span.textContent = childSnap.key;

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete";
      deleteBtn.className = "deleteBtn";
      deleteBtn.addEventListener("click", e => {
        e.stopPropagation();
        remove(child(subitemsRef, childSnap.key));
      });

      li.appendChild(span);
      li.appendChild(deleteBtn);
      subitemsList.appendChild(li);
    });
  });

  // Alt başlık ekleme
  addSubBtn.addEventListener("click", () => {
    const subTitle = subtitleInput.value.trim();
    if (!subTitle) return alert("Please enter a subitem!");

    const sanitizedKey = subTitle.replace(/[.#$/\[\]]/g, "_");
    const subitemRef = child(subitemsRef, sanitizedKey);
    set(subitemRef, { type: "subtitle" });

    subtitleInput.value = "";
  });

}, 'login.html');
</script>

</body>
</html>
