<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Alt Başlıklar</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
<div id="container">
  <h1 id="currentTitle">Yükleniyor...</h1>

  <div class="input-group">
    <input type="text" id="subtitleInput" placeholder="Yeni alt başlık" />
    <button id="addSubtitleBtn">Ekle</button>
  </div>

  <ul id="subtitlesList"></ul>
</div>

<script type="module">
import { checkAuth, userPathRef } from './firebaseConfig.js';
import { onValue, set, remove, child, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const currentTitle = document.getElementById('currentTitle');
const subtitleInput = document.getElementById('subtitleInput');
const addSubtitleBtn = document.getElementById('addSubtitleBtn');
const subtitlesList = document.getElementById('subtitlesList');

let currentUserId = null;
let currentPath = "";

// URL param
const params = new URLSearchParams(window.location.search);
currentPath = params.get("path");
if (!currentPath) {
  alert("Path bulunamadı!");
  window.location.href = "index.html";
}

// Key temizleme
function sanitizeKey(s) {
  return String(s || '').trim()
    .replace(/\//g, '-')       
    .replace(/[.$#[\]]/g, '-') 
    .replace(/\s+/g, ' ')      
    .replace(/^\s+|\s+$/g, '');
}

checkAuth(user => {
  currentUserId = user.uid;
  const pathRef = userPathRef(currentUserId, currentPath);

  currentTitle.textContent = decodeURIComponent(currentPath);

  // Alt başlıkları dinle
  onValue(pathRef, snapshot => {
    subtitlesList.innerHTML = '';
    if (!snapshot.exists()) return;

    snapshot.forEach(childSnap => {
      const key = childSnap.key;
      const val = childSnap.val();

      // Yalnızca type: "subtitle" olanları göster
      if (val.type !== "subtitle") return;

      const li = document.createElement('li');
      li.style.display = "flex";
      li.style.alignItems = "center";
      li.style.gap = "8px";

      const span = document.createElement('span');
      span.textContent = key;
      span.style.cursor = "pointer";

      // Alt başlığa tıklayınca yeni path ile page.html aç
     // Alt başlığa tıklayınca yeni path ile page.html aç
        span.addEventListener('click', e => {
          e.stopPropagation();
          const newPath = currentPath + "/" + key;
          window.location.href = `page.html?path=${encodeURIComponent(newPath)}`;
        });


      const delBtn = document.createElement('button');
      delBtn.textContent = "Sil";
      delBtn.className = "deleteBtn";
      delBtn.onclick = e => {
        e.stopPropagation();
        if (!confirm(`"${key}" silinsin mi?`)) return;
        remove(child(pathRef, key));
      };

      li.appendChild(span);
      li.appendChild(delBtn);
      subtitlesList.appendChild(li);
    });
  });

  // Yeni alt başlık ekleme
  addSubtitleBtn.onclick = async () => {
    const raw = subtitleInput.value;
    const key = sanitizeKey(raw);
    if (!key) return alert('Geçerli bir alt başlık girin!');
    const existing = await get(child(pathRef, key));
    if (existing.exists()) return alert('Bu alt başlık zaten var!');
    set(child(pathRef, key), { type: "subtitle" })
      .then(() => { subtitleInput.value = ''; })
      .catch(err => alert('Ekleme hatası: ' + err.message));
  };

}, 'login.html');
</script>
</body>
</html>
